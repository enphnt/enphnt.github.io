---
title: "Uprading this very Gatsby blog (v1 => v4)"
date: "2023-02-02"
slug: gatsby-upgrades
thumbnail: "./thumbnail.png"
hero_image: "./hero.jpg"
hero_image_alt: "a picture of me upgrading gatsby"
hero_image_credit_text: "cottonbro studio"
hero_image_credit_link: "https://www.pexels.com/photo/black-screen-with-code-4164418"
tags: ["gatsby", "upgrades", "web dev"]

---

First of all, I'm running such an old version of Gatsby that I can't use any of its newest features. In order to use SEO tools, I need to upgrade to `gatsby@4.19.0`.

My notes from performing the upgrade are included in this post. 

# v1 to v2 upgrade
I'll try just setting package.json version to 2.0.0:
```json
  
  "dependencies": {
    "gatsby": "^2.0.0",
  }


```

After running `npm i`, I needed to update all the peers of gatsby to a higher version too. After doing that, `react` and `react-dom` packages were added because in v1 these were bundled inside gatsby but no longer are.

I was able to finish the install of new packages and render the site successfully using my package script: `npm run develop`

However, now I see massive layout issues and I will move on to restructuring my react components so that they no longer use the `layout.js` as a root component.

After the following steps, which are thankfully documented in the [migration guide](https://www.gatsbyjs.com/docs/reference/release-notes/migrating-from-v1-to-v2/), I'm up and running again. Had to do the following steps.

  1. Convert layout's children from render prop to normal prop (required)
  2. Mv `layouts/index.js` to `src/components/layout.js` (optional, but recommended)
  3. Import then wrap pages with layout component
  4. Pass history, location, and match props to layout (didn't do this actually)
  5. Change the query to use StaticQuery (now getting false pos warn about `'maxWidth'` in query)

## v2 Done
We made it. Things so far have remained straightforward. Next I'll continue upgrading to v4 now from v2.

# v2 to v4 upgrade
For this migration, I skipped 3 altogether as I saw few breaking changes that would affect me. In fact, it looks like none! Even further migrating to v4 shows no apparent breaking changes i'll need to address.

I updated the package.json to the latest release for v4 according to npm:
  ```json

      "gatsby": "4.25.2",
  

  ```

After that, I updated all the gatsby plugin and peers to their latest v4 versions (using npm versions page as my reference):
```json
    
    "gatsby-plugin-catch-links": "^4.25.0",
    "gatsby-plugin-react-helmet": "5.25.0",
    "gatsby-source-filesystem": "^4.25.0",
    "gatsby-transformer-remark": "^5.25.1",


```
Luckily, not too many packages.

On installing, I faced nothing major except a few warnings. I ended up facing more issues when I tried to run `gatsby develop`. Errors looked like:
```

failed Building production JavaScript and CSS bundles - 4.511s

ERROR #98124  WEBPACK

Generating JavaScript bundles failed

Can't resolve '@gatsbyjs/reach-router/lib/utils' in '/Users/nathanphennel/Projects/blog/.cache'

If you're trying to use a package make sure that '@gatsbyjs/reach-router/lib/utils' is installed.
If you're trying to use a local file make sure that the path is correct.

File: .cache/find-path.js:1:0


```

To overcome these, I found that its necessary to add gatsby peer deps to the `package.json` for some unknown reason. I saw there was a bit of chatter about deps issues on gatsby's github [issues](https://github.com/gatsbyjs/gatsby/discussions/35313). [Here](https://github.com/gatsbyjs/gatsby/issues/25708), I saw I could just bypass issues with the transient deps and just specify compatible versions myself in the `package.json` like so:

```javascript

  "gatsby-link": "^4.25.0",
  "gatsby-react-router-scroll": "^5.25.0",
  "@gatsbyjs/reach-router": "1.3.9",
  "gatsby-script": "^1.10.0",


```

After this update, I ran the following:
```shell
  
  rm -rf node_modules/
  rm package-lock.json
  rm -rf .cache
  npm i
  npm run clean
  npm i
  npm run develop


```

Upon completely reseting all the deps for v4, things were back up and running. Only one small issue noticeable in the terminal remains when running `gatsby develop`:
```

warn Warning: there are unknown plugin options for "gatsby-source-filesystem": fastHash
Please open an issue at https://ghub.io/gatsby-source-filesystem if you believe this option is valid.


```

Turns out, this is now handled automatically by the plugin. I don't need to specify `fastHash` for detecting changes to images any longer. Nice! Now I'm running with no noticeable issues and no major console warnings/errors.

# Conclusion
There are some growing pains for Gatsby, but nothing out of the ordinary. It was surprisingly smooth to upgrade to v4. My next step will be to implement some of the SEO tools that Gatsby has to offer and test that things are working when I Google myself.